"use strict";var Demi={Models:{},Collections:{},Views:{},Routers:{},models:{},collections:{},views:{},routers:{},current:{},promises:{}};Demi.Models.Assignment=Backbone.Model.extend({url:function(){return"http://normalizer.herokuapp.com/assignments/"+this.id},toJSON:function(){return JSON.stringify({assignment:this.attributes})}}),Demi.Collections.Assignments=Backbone.Collection.extend({model:Demi.Models.Assignment,url:function(){return"http://normalizer.herokuapp.com/timelines/"+Demi.current.timeline.id+"/weeks/"+Demi.current.week.id+"/assignments"}}),Demi.Models.Course=Backbone.Model.extend({type:"course",generateURI:function(){return"#/courses/"+this.id}}),Demi.Collections.courses=Backbone.Collection.extend({model:Demi.Models.Course,url:"http://normalizer.herokuapp.com/courses"}),Demi.Models.Goal=Backbone.Model.extend({url:function(){return"http://normalizer.herokuapp.com/goals/"+this.id},toJSON:function(){return JSON.stringify({goal:this.attributes})}}),Demi.Collections.Goals=Backbone.Collection.extend({model:Demi.Models.Goal,url:function(){return"http://normalizer.herokuapp.com/timelines/"+Demi.current.timeline.id+"/weeks/"+Demi.current.week.id+"/goals"}}),Demi.Models.Resource=Backbone.Model.extend({url:function(){return"http://normalizer.herokuapp.com/resources/"+this.id},toJSON:function(){return JSON.stringify({resource:this.attributes})}}),Demi.Collections.Resources=Backbone.Collection.extend({model:Demi.Models.Resource,url:function(){return"http://normalizer.herokuapp.com/timelines/"+Demi.current.timeline.id+"/weeks/"+Demi.current.week.id+"/resources"}}),Demi.Models.Timeline=Backbone.Model.extend({type:"timeline",generateURI:function(){return"#/courses/"+Demi.current.course.id+"/timelines/"+this.id}}),Demi.Collections.timelines=Backbone.Collection.extend({model:Demi.Models.Timeline,url:function(){return"http://normalizer.herokuapp.com/courses/"+Demi.current.course.id+"/timelines"}}),Demi.Models.Week=Backbone.Model.extend({type:"week",idAttribute:"number",initialize:function(){this.set("name","Week "+this.get("number"))},generateURI:function(){return"#/courses/"+Demi.current.course.id+"/timelines/"+Demi.current.timeline.id+"/weeks/"+this.get("number")}}),Demi.Collections.weeks=Backbone.Collection.extend({model:Demi.Models.Week,url:function(){return"http://normalizer.herokuapp.com/timelines/"+Demi.current.timeline.id},parse:function(e){return e.weeks}}),Demi.Views.DropdownItem=Backbone.View.extend({tagName:"li",events:{click:"setDropdowText"},initialize:function(){this.$target=$("#"+this.model.type+"-list-dropdown"),this.$target.append(this.el),this.render(),this.listenTo(this.model,"change",this.render),this.listenTo(this.model.collection,"reset",this.remove)},render:function(){this.$el.html('<li role="presentation"><a role="menuitem" tabindex="-1" href="'+this.model.generateURI()+'">'+this.model.get("name")+"</a></li>")},setDropdowText:function(){this.$target.prev().children(".button-text").text(this.model.get("name"))}}),Demi.Views.Assignment=Backbone.View.extend({tagName:"li",className:"item row",template:_.template($(".assignment-template").text()),events:{"click .delete-button":"destroy"},initialize:function(){$(".assignment-items ol").append(this.el),this.render()},render:function(){this.$el.html(this.template(this.model.attributes))},destroy:function(){this.model.destroy(),this.remove()}}),Demi.Views.Goal=Backbone.View.extend({tagName:"li",className:"item row",template:_.template($(".goal-template").text()),initialize:function(){$(".goal-items ol").append(this.el),this.render()},events:{"click .delete-button":"destroy"},render:function(){this.$el.html(this.template(this.model.attributes))},destroy:function(){this.model.destroy(),this.remove()}}),Demi.Views.Resource=Backbone.View.extend({tagName:"li",className:"item row",template:_.template($(".resource-template").text()),initialize:function(){$(".resource-items ol").append(this.el),this.render()},events:{"click .delete-button":"destroy"},render:function(){this.$el.html(this.template(this.model.attributes))},destroy:function(){this.model.destroy(),this.remove()}}),Demi.Views.Week=Backbone.View.extend({events:{"click .save-assignment":"saveAssignment","click .save-resource":"saveResource","click .save-goal":"saveGoal"},template:_.template($(".week-template").text()),initialize:function(){$(".week-container").append(this.el),this.render()},render:function(){this.$el.html(this.template())},saveAssignment:function(){Demi.collections.assignments.add({assignment:{description:$(".input-assignment").val()}}).save()},saveResource:function(){Demi.collections.resources.add({resource:{description:$(".input-resource-url").val(),url:$(".input-resource-description").val()}}).save()},saveGoal:function(){Demi.collections.goals.add({goal:{description:$(".input-goal").val()}}).save()}}),Demi.Routers.AppRouter=Backbone.Router.extend({routes:{"":"loadCourses","courses/:courseId":"loadTimelines","courses/:courseId/timelines/:timelineId":"loadWeeks","courses/:courseId/timelines/:timelineId/weeks/:weekNumber":"loadWeek"},initialize:function(){new Demi.Views.Week,Demi.collections.courses=new Demi.Collections.courses,Demi.collections.timelines=new Demi.Collections.timelines,Demi.collections.weeks=new Demi.Collections.weeks,Demi.collections.goals=new Demi.Collections.Goals,Demi.collections.resources=new Demi.Collections.Resources,Demi.collections.assignments=new Demi.Collections.Assignments,this.listenTo(Demi.collections.courses,"add",function(e){new Demi.Views.DropdownItem({model:e})}),this.listenTo(Demi.collections.timelines,"add",function(e){new Demi.Views.DropdownItem({model:e})}),this.listenTo(Demi.collections.weeks,"add",function(e){new Demi.Views.DropdownItem({model:e})}),this.listenTo(Demi.collections.goals,"add",function(e){new Demi.Views.Goal({model:e})}),this.listenTo(Demi.collections.resources,"add",function(e){new Demi.Views.Resource({model:e})}),this.listenTo(Demi.collections.assignments,"add",function(e){new Demi.Views.Assignment({model:e})}),Demi.promises.coursePromise=Demi.collections.courses.fetch()},execute:function(e,i){this.assumeAndPrefetch(),e&&e.apply(this,i)},assumeAndPrefetch:function(){var e,i,t,s=window.location.hash.split("/");(e=this.urlHas(s,"courses"))?(Demi.current.course=Demi.collections.courses.add({id:s[e]}),Demi.promises.timelinePromise=Demi.collections.timelines.fetch()):Demi.current.course=void 0,(i=this.urlHas(s,"timelines"))?(Demi.current.timeline=Demi.collections.timelines.add({id:s[i]}),Demi.promises.weekPromise=Demi.collections.weeks.fetch()):Demi.current.timeline=void 0,Demi.current.week=(t=this.urlHas(s,"weeks"))?Demi.collections.weeks.add({number:s[t]}):void 0},loadCourses:function(e){return this.promises(1).done(this.setDropdowns),e&&this.erase(["timelines","weeks"]),this},loadTimelines:function(e){return this.promises(2).done(this.setDropdowns),e&&this.erase(["timelines","weeks"]),this},loadWeeks:function(e){return this.promises(3).done(this.setDropdowns),e&&this.erase(["weeks"]),this},loadWeek:function(){return $(".assignment-items ol, .resource-items ol, .goal-items ol").html(""),this.promises(3).done(function(){this.setDropdowns(),_.each(Demi.current.week.get("resources"),function(e){Demi.collections.resources.add(e)}),_.each(Demi.current.week.get("goals"),function(e){Demi.collections.goals.add(e)}),_.each(Demi.current.week.get("assignments"),function(e){Demi.collections.assignments.add(e)})}.bind(this)),this},erase:function(e){console.log("erasing",e),_.each(e,function(e){Demi.collections[e].reset()}),$(".assignment-items ol, .resource-items ol, .goal-items ol").html(""),this.setDropdowns()},urlHas:function(e,i){return _.indexOf(e,i)+1},setDropdowns:function(){_.each(["course","timeline","week"],function(e){$("#"+e+"-list-dropdown").prev().find(".button-text").text(Demi.current[e]?Demi.current[e].get("name"):"choose")})},promises:function(e){return $.when.apply(this,[Demi.promises.coursePromise,Demi.promises.timelinePromise,Demi.promises.weekPromise].slice(0,e))}}),Backbone._sync=Backbone.sync,Backbone.sync=function(e,i,t){return t.beforeSend=function(e){var i="Mellon";return i?e.setRequestHeader("Authorization",i):void 0},Backbone._sync(e,i,t)};var router=new Demi.Routers.AppRouter;Backbone.history.start(),$(".menu-button").click(function(){$("nav").animate({height:"toggle"},400,function(){})});